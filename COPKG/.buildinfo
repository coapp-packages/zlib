/* target information */
@import "version.inc";

#product-info  {
	product-name: "zlib";
	version: "${package-version}";
	original-source-location: "http://zlib.net/zlib125.zip";
	original-source-website: "http://zlib.net";
	license: "zlib license -- http://zlib.net/zlib_license.html";
	packager: "garrett serack <garretts@microsoft.com>";
}

test {
    set : COMP="${COMP??vc10, vc9}"; // suggested full list = "vc10, vc9, vc8, vc7.1, vc6, mingw";
    set : PLAT="${PLAT??x86, x64}";
	default : false;
	
	build-command : @"
        if ""${BUILT}"" neq ""true"" ptk release --COMP=""${COMP}"" --PLAT=""${PLAT}""
        for %%a in (${COMP}) do (
            for %%b in (${PLAT}) do (
                ptk --nologo --COMP=%%a --PLAT=%%b test-loop
            )
        )
	";
}

test-loop {
    set : COMP="${COMP??vc10}";
    set : PLAT="${PLAT??x86}";
	default : false;
	
	build-command : @"
        setlocal enabledelayedexpansion
		set init_var=""This is a test...""
        set ans_var=init

        pushd output\${COMP}\${PLAT}\release\bin\ || goto failed
        example.exe	> nul 2> nul || goto failed
        example_d.exe > nul 2> nul || goto failed
        for /F ""tokens=*"" %%a in ('echo %init_var% ^| minigzip ^| minigzip -d') do (set ans_var=%%a)
        if %init_var% neq %ans_var% (goto failed)
        for /F ""tokens=*"" %%a in ('echo %init_var% ^| minigzip_d ^| minigzip_d -d') do (set ans_var=%%a)
        if %init_var% neq %ans_var% (goto failed)
        testzlib.exe zlibwapi.dll > nul 2> nul || goto failed
        testzlibstatic.exe zlibwapi.dll > nul 2> nul || goto failed
        popd
        echo ${COMP}\${PLAT} tests passed...
        
        endlocal
	";
}

package {
    set : COMP="${COMP??vc10, vc9}"; // suggested full list = "vc10, vc9, vc8, vc7.1, vc6, mingw";
    set : PLAT="${PLAT??x86, x64}";
    default : false;
    
    // In future versions of pTk, we hope to be able to make this list more concise and maliable.
    targets: { 
    };
    
    build-command : @"
        if ""${BUILT}"" neq ""true"" ptk release --COMP=""${COMP}"" --PLAT=""${PLAT}""
        
        cd COPKG
        autopackage zlib-dev-common.autopkg || goto failed
        for %%A in (${COMP}) do (
            for %%B in (${PLAT}) do (
                autopackage --flav=%%A --arc=%%B zlib.autopkg zlib-dev.autopkg || goto failed
            )
        )
        ptk update-version
    ";
}

update-version {
    default : false;
    
    build-command : @"
        REM auto-increment version.inc file...
        
        cd COPKG
        setlocal EnableDelayedExpansion
        for /F ""tokens=4,5,6,7  delims=.; "" %%v in (version.inc) do (
            set /a build=%%y + 1
            set VERSTRING=#define { package-version: %%v.%%w.%%x.!build!; }
        )
        echo !VERSTRING! > version.inc
    ";
}

sign {
    default : false;

    uses : release;

    build-command : @"
        REM Sign binaries.
        echo [Skipping binary signing -- autopackage will sign and manifest the binaries for us]
    ";
}

release {
    set: { 
        BUILD_CFG ="release";
        COMP="${COMP??vc10, vc9}"; // suggested full list = "vc10, vc9, vc8, vc7.1, vc6, mingw";
        PLAT="${PLAT??x86, x64}";
    };
    
    /*  Note that I do not use a "uses" here.
        In a future version of pTk, we hope to provide expanded syntax for iterating through 
        a list like ALL_COMPILERS and making "set" and "uses" statements inside the loop.
        At present, this is the most workable solution for compiling multiple flavors on demand.
     */
    
    build-command : @"
        for %%a in (${COMP}) do (
            for %%b in (${PLAT}) do (
                if ""%%a"" equ ""vc6"" (
                    ptk --COMP=%%a --CO_SDK=feb2003 %%b
                ) else (
                    ptk --COMP=%%a %%b
                )
                ptk clean %%b
            )
        )
    ";
}

debug {
    default : false;
    set: { 
        BUILD_CFG ="debug";
        COMP="${COMP??vc10, vc9}"; // suggested full list = "vc10, vc9, vc8, vc7.1, vc6, mingw";
        PLAT="${PLAT??x86, x64}";
    };
    
    /*  Note that I do not use a "uses" here.
        In a future version of pTk, we hope to provide expanded syntax for iterating through 
        a list like ALL_COMPILERS and making "set" and "uses" statements inside the loop.
        At present, this is the most workable solution for compiling multiple flavors on demand.
     */
    
    build-command : @"
        for %%a in (${COMP}) do (
            for %%b in (${PLAT}) do (
                if ""%%a"" equ ""vc6"" (
                    ptk --COMP=%%a --CO_SDK=feb2003 %%b
                ) else (
                    ptk --COMP=%%a %%b
                )
                ptk clean %%b
            )
        )
    ";
}


x86 {   
    default : false;

    set: { 
        OUTPUT_ARCH="x86";
        OUTPUT_VERSION="${package-version}"; // this got picked up from the @import rule at the top.
        COMP="${COMP??vc10}";
        BUILD_CFG="${BUILD_CFG??debug}";
    };
    
    platform: x86;
    compiler: "${COMP}";
    sdk: "${CO_SDK??sdk7.1}";
    
    uses : prep;
    
    targets: { 
		@"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\miniunz.exe",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\minizip.exe",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\testzlibstatic.exe",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\testzlib.exe",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\zlibwapi.dll",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlibwapi.lib",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlibstat.lib",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib.lib",             
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib1.lib",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib1.exp",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\zlib1.dll"
	};
	
    build-command:@"
		REM This avoids problems of ambiguity later...
		rem Do zlibwapi build...
        pushd contrib\masmx86\
            call bld_ml32.bat
        popd 
		msbuild /p:Platform=win32 /p:Configuration=${BUILD_CFG} contrib\vstudio\${COMP}\zlibvc.sln || goto failed

        rem Do zlib1 build...
        copy contrib\masmx86\inffas32.obj inffas32.obj || goto failed
        copy contrib\masmx86\match686.obj match686.obj || goto failed

        rem Makefile was modified to put output to temp dir, so we can have x86 and x64 builds at the same time
        mkdir temp
        rem lets clean out all the obj's first, otherwise we might accidentally link to another arch
        nmake -f win32/Makefile.msc clean || goto failed
        nmake -f win32/Makefile.msc LOC=""-DASMV -DASMINF"" OBJA=""match686.obj inffas32.obj"" || goto failed

        rem grab out outputs and put them in a consistent location.
        copy temp\zlib.lib  output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib.lib                  || goto failed
        copy temp\zlib1.lib output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib1.lib                 || goto failed
        copy temp\zlib1.exp output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib1.exp                 || goto failed
        copy temp\zlib1.dll output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\zlib1.dll                 || goto failed

        copy contrib\vstudio\${COMP}\x86\MiniUnzip%BUILD_CFG%\miniunz.exe     output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\miniunz.exe    || goto failed 
        copy contrib\vstudio\${COMP}\x86\MiniZip%BUILD_CFG%\minizip.exe       output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\minizip.exe    || goto failed 
        copy contrib\vstudio\${COMP}\x86\TestZlibDll%BUILD_CFG%\testzlib.exe  output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\testzlib.exe   || goto failed 
        copy contrib\vstudio\${COMP}\x86\TestZlib%BUILD_CFG%\testzlib.exe     output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\testzlibstatic.exe   || goto failed 
        copy contrib\vstudio\${COMP}\x86\ZlibDll%BUILD_CFG%\zlibwapi.dll      output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\zlibwapi.dll   || goto failed 
        copy contrib\vstudio\${COMP}\x86\ZlibDll%BUILD_CFG%\zlibwapi.lib      output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlibwapi.lib   || goto failed 
        copy contrib\vstudio\${COMP}\x86\ZlibStat%BUILD_CFG%\zlibstat.lib     output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlibstat.lib   || goto failed 
		copy example.exe	output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\example.exe	|| goto failed 
		copy minigzip.exe	output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\minigzip.exe	|| goto failed 
		copy example_d.exe	output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\example_d.exe	|| goto failed 
		copy minigzip_d.exe	output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\minigzip_d.exe	|| goto failed 
	";
    
    clean-command:@"
       erase contrib\masmx86\inffas32.lst  > nul 2> nul
       erase contrib\masmx86\inffas32.obj  > nul 2> nul
       erase contrib\masmx86\match686.lst  > nul 2> nul
       erase contrib\masmx86\match686.obj  > nul 2> nul
       if exist contrib\vstudio\${COMP}\x86 rmdir /s /q contrib\vstudio\${COMP}\x86  > nul 2> nul
       if exist temp rmdir /s /q temp > nul 2> nul
       if exist Release rmdir /s /q Release > nul 2> nul
       rem best you have your visual studio installed in the default location...
       REM IF EXIST ""C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" call ""C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" x86
       REM IF EXIST ""C:\Program Files\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" call ""C:\Program Files\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" x86
       nmake -f win32/Makefile.msc clean   > nul 2> nul
    ";
};

x64 {
    default : false;

    set: { 
        OUTPUT_ARCH="x64";
        OUTPUT_VERSION="${package-version}"; // this got picked up from the @import rule at the top.
        COMP="${COMP??vc10}";
        BUILD_CFG="${BUILD_CFG??debug}";
    };
    
    platform: x64;
    compiler: "${COMP}";
    sdk: "${CO_SDK??sdk7.1}";

    uses : prep;

	targets: { 
		@"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\miniunz.exe",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\minizip.exe",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\testzlibstatic.exe",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\testzlib.exe",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\zlibwapi.dll",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlibwapi.lib",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlibstat.lib",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib.lib",             
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib1.lib",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib1.exp",
        @"output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\zlib1.dll"
	};
	
    build-command:@"
        REM This avoids problems of ambiguity later...
		rem Do zlibwapi build...
        pushd contrib\masmx64\
        call bld_ml64.bat
        popd 
        msbuild /p:Platform=x64 /p:Configuration=${BUILD_CFG} contrib\vstudio\${COMP}\zlibvc.sln || goto failed

        rem Do zlib1 build...
        copy contrib\masmx64\inffasx64.obj inffasx64.obj
        copy contrib\masmx64\gvmat64.obj gvmat64.obj 
        copy contrib\masmx64\inffas8664.c inffas8664.c
        
        rem best you have your visual studio installed in the default location...
        REM IF EXIST ""C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" call ""C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" amd64
        REM IF EXIST ""C:\Program Files\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" call ""C:\Program Files\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" x86_amd64

        mkdir temp
        rem I couldn't get the makefile to do this bit properly without changing it somewhat, so Ill do it myself for now
        rem lets clean out all the obj's first, otherwise we might accidentally link to another arch
        nmake -f win32/Makefile.msc clean
        cl -nologo -MD -W3 -O2 -Oy- -Zi -Fd""zlib"" -DASMV -DASMINF inffas8664.c
        nmake -f win32/Makefile.msc AS=ml64 LOC=""-DASMV -DASMINF"" OBJA=""inffasx64.obj gvmat64.obj inffas8664.obj"" 

        rem grab out outputs and put them in a consistent location.
        copy temp\zlib.lib  output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib.lib                  || goto failed
        copy temp\zlib1.lib output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib1.lib                 || goto failed
        copy temp\zlib1.exp output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlib1.exp                 || goto failed
        copy temp\zlib1.dll output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\zlib1.dll                 || goto failed

        copy contrib\vstudio\${COMP}\x64\MiniUnzip%BUILD_CFG%\miniunz.exe     output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\miniunz.exe    || goto failed 
        copy contrib\vstudio\${COMP}\x64\%BUILD_CFG%\minizip.exe       output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\minizip.exe    || goto failed 
        copy contrib\vstudio\${COMP}\x64\TestZlibDll%BUILD_CFG%\testzlib.exe  output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\testzlib.exe   || goto failed 
        copy contrib\vstudio\${COMP}\x64\TestZlib%BUILD_CFG%\testzlib.exe     output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\testzlibstatic.exe   || goto failed 
        copy contrib\vstudio\${COMP}\x64\ZlibDll%BUILD_CFG%\zlibwapi.dll      output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\zlibwapi.dll   || goto failed 
        copy contrib\vstudio\${COMP}\x64\ZlibDll%BUILD_CFG%\zlibwapi.lib      output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlibwapi.lib   || goto failed 
        copy contrib\vstudio\${COMP}\x64\ZlibStat%BUILD_CFG%\zlibstat.lib     output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib\zlibstat.lib   || goto failed 
		copy example.exe	output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\example.exe	|| goto failed 
		copy minigzip.exe	output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\minigzip.exe	|| goto failed 
		copy example_d.exe	output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\example_d.exe	|| goto failed 
		copy minigzip_d.exe	output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin\minigzip_d.exe	|| goto failed 
    ";

    clean-command:@"
       erase contrib\masmx64\inffasx64.lst  > nul 2> nul
       erase contrib\masmx64\inffasx64.obj  > nul 2> nul
       erase contrib\masmx64\gvmat64.lst  > nul 2> nul
       erase contrib\masmx64\gvmat64.obj  > nul 2> nul
       erase inffas8664.c  > nul 2> nul
       if exist contrib\vstudio\vc10\x64 rmdir /s /q contrib\vstudio\vc10\x64  > nul 2> nul
       if exist Release rmdir /s /q Release > nul 2> nul
       if exist temp rmdir /s /q temp > nul 2> nul
       rem best you have your visual studio installed in the default location...
       REM IF EXIST ""C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" call ""C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" amd64
       REM IF EXIST ""C:\Program Files\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" call ""C:\Program Files\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"" x86_amd64
       nmake -f win32/Makefile.msc clean  > nul 2> nul
    ";
};

prep {
    default : false;

    build-command:@"
        mkdir output
        mkdir output\${COMP}
        mkdir output\${COMP}\${OUTPUT_ARCH}
        mkdir output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}
        mkdir output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\bin
        mkdir output\${COMP}\${OUTPUT_ARCH}\${BUILD_CFG}\lib
    ";
}

